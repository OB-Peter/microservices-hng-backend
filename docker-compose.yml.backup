name: Deploy Notification System
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Clean up old containers and volumes
        run: docker compose down -v
      
      - name: Start services
        run: docker compose up -d --build
      
      - name: Wait for services to initialize
        run: sleep 25
      
      - name: Check container status
        run: docker compose ps
      
      - name: Health check - API Gateway
        run: |
          max_attempts=30
          attempt=0
          until curl -f http://localhost:8001/health 2>/dev/null || [ $attempt -eq $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts for api-gateway..."
            sleep 2
          done
          if [ $attempt -eq $max_attempts ]; then
            echo "API Gateway health check failed"
            docker compose logs api-gateway
            exit 1
          fi
          echo "API Gateway is healthy"
      
      - name: Health check - User Service
        run: |
          max_attempts=30
          attempt=0
          until curl -f http://localhost:8002/health 2>/dev/null || [ $attempt -eq $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts for user-service..."
            sleep 2
          done
          if [ $attempt -eq $max_attempts ]; then
            echo "User Service health check failed"
            docker compose logs user-service
            exit 1
          fi
          echo "User Service is healthy"
      
      - name: Health check - Template Service
        run: |
          max_attempts=30
          attempt=0
          until curl -f http://localhost:8003/health 2>/dev/null || [ $attempt -eq $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts for template-service..."
            sleep 2
          done
          if [ $attempt -eq $max_attempts ]; then
            echo "Template Service health check failed"
            docker compose logs template-service
            exit 1
          fi
          echo "Template Service is healthy"
      
      - name: Health check - Email Service
        run: |
          max_attempts=30
          attempt=0
          until curl -f http://localhost:8004/health 2>/dev/null || [ $attempt -eq $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts for email-service..."
            sleep 2
          done
          if [ $attempt -eq $max_attempts ]; then
            echo "Email Service health check failed"
            docker compose logs email-service
            exit 1
          fi
          echo "Email Service is healthy"
      
      - name: Health check - Push Service
        run: |
          max_attempts=30
          attempt=0
          until curl -f http://localhost:8005/health 2>/dev/null || [ $attempt -eq $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts for push-service..."
            sleep 2
          done
          if [ $attempt -eq $max_attempts ]; then
            echo "Push Service health check failed"
            docker compose logs push-service
            exit 1
          fi
          echo "Push Service is healthy"
      
      - name: Test notification API
        run: |
          response=$(curl -X POST http://localhost:8001/notifications \
            -H "Content-Type: application/json" \
            -d '{"user_id":"test","type":"email","title":"CI Test","message":"Testing"}')
          echo $response | grep -q "success" || exit 1
      
      - name: Show logs on failure
        if: failure()
        run: docker compose logs
      
      - name: Cleanup
        run: docker compose down
  
  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push API Gateway
        uses: docker/build-push-action@v4
        with:
          context: ./api-gateway
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/notification-api-gateway:latest
      
      - name: Build and push User Service
        uses: docker/build-push-action@v4
        with:
          context: ./user-service
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/notification-user-service:latest
      
      - name: Build and push Email Service
        uses: docker/build-push-action@v4
        with:
          context: ./email-service
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/notification-email-service:latest
      
      - name: Build and push Push Service
        uses: docker/build-push-action@v4
        with:
          context: ./push-service
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/notification-push-service:latest
      
      - name: Build and push Template Service
        uses: docker/build-push-action@v4
        with:
          context: ./template-service
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/notification-template-service:latest
  
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/notification-system
            git pull origin main
            docker compose pull
            docker compose up -d --remove-orphans
            docker system prune -f
            
            # Wait for services to be healthy
            sleep 10
            
            # Health checks
            curl -f http://localhost:8001/health || exit 1
            
            echo "Deployment successful!"
